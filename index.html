<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Macnab 2025 Financial Matrix — Updated</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f4f6f8; }
    h1, h2 { margin-bottom: 10px; }
    fieldset { border: 1px solid #ccc; margin-bottom: 20px; padding: 15px; background: #fff; }
    legend { font-weight: bold; }
    .input-grid {
      display: grid;
      grid-template-columns: 250px 150px 250px;
      row-gap: 10px;
      column-gap: 10px;
      align-items: center;
    }
    input[type="number"], input[type="range"] {
      width: 100%;
      padding: 5px;
      box-sizing: border-box;
    }
    input[type="checkbox"] {
      width: auto;
      transform: scale(1.2);
      margin-right: 8px;
      vertical-align: middle;
    }
    .summary {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 15px;
      margin-top: 20px;
    }
    .card {
      background: #fff;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      text-align: center;
    }
    .income { color: green; }
    .cost { color: red; }
    .profit-positive { color: green; font-weight: bold; }
    .profit-negative { color: red; font-weight: bold; }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      background: #fff;
      display: block;
      overflow-x: auto;
      white-space: nowrap;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px 10px;
      text-align: center;
    }
    th {
      background: #dee2e6;
      position: sticky;
      top: 0;
      z-index: 1;
    }
    td { vertical-align: top; }
    td small { display: block; font-size: 0.8em; color: #555; }

    th:nth-child(1), td:nth-child(1) { min-width: 100px; text-align: left; }

    .calc-section {
      background: #f9f9f9;
      padding: 12px;
      border-radius: 6px;
      margin-top: 10px;
    }
    .calc-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 15px;
      margin-top: 10px;
    }
    .calc-card {
      background: #fff;
      padding: 12px;
      border-radius: 6px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .calc-card h3 {
      margin: 0 0 8px 0;
      font-size: 0.95em;
    }
    .best-suggestion {
      background: #e8f5e9;
      padding: 8px;
      border-radius: 4px;
      margin-top: 6px;
      font-size: 0.9em;
      color: #2e7d32;
    }
    .note {
      color: #666;
      font-size: 0.85em;
      font-style: italic;
    }
    .divisor-table {
      width: 100%;
      font-size: 0.85em;
      margin-top: 6px;
    }
    .divisor-table td {
      padding: 4px;
      border: 1px solid #e0e0e0;
    }
    button {
      background: #0066cc;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9em;
    }
    button:hover { background: #0052a3; }
  </style>
</head>
<body>
  <h1>Macnab 2025 Financial Matrix — Updated</h1>

  <fieldset>
    <legend>Fixed Costs</legend>
    <div class="input-grid">
      <label>Venue Hire (£):</label>
      <input type="number" id="venueHire" value="300" min="0"><span></span>

      <label>Comedian (£):</label>
      <input type="number" id="comedian" value="325" min="0"><span></span>
    </div>
  </fieldset>

  <fieldset>
    <legend>Variable Costs</legend>
    <div class="input-grid">
      <label>Base Attendance:</label>
      <input type="number" id="attendanceInput" value="107" min="0"><span></span>

      <label>Masonic %:</label>
      <input type="range" id="masonicPercent" value="90" min="0" max="100">
      <span>
        <span id="masonicLabel">90%</span>
        (<span id="masonicGuests">0</span> M, <span id="nonMasonicGuests">0</span> NM)
      </span>

      <label>Wine Bottles (used):</label>
      <input type="number" id="wineBottlesInput" value="26" min="0"><span></span>

      <label>Complimentary Tickets:</label>
      <input type="number" id="compTickets" value="7" min="0"><span></span>

      <label>Other Miscellaneous Costs (Organist, Tyler) (£):</label>
      <input type="number" id="charityInput" value="85" min="0"><span></span>
    </div>
  </fieldset>

  <fieldset>
    <legend>Projected Income</legend>
    <div class="input-grid">
      <label>Raffle Income (£): <small>£5 per ticket strip</small></label>
      <input type="number" id="raffleIncome" value="788" min="0">
      <span id="raffleCount" style="font-size: 0.9em;"></span>

      <label>Fish Race Income (£): <small>£5 per ticket</small></label>
      <input type="number" id="fishRaceIncome" value="585" min="0">
      <span id="fishCount" style="font-size: 0.9em;"></span>

      <label>Bottle Comp Income (£): <small>£1 per go</small></label>
      <input type="number" id="bottleCompIncome" value="169" min="0">
      <span id="bottleCount" style="font-size: 0.9em;"></span>

      <label>Card Transactions (%):</label>
      <input type="range" id="cardTransactions" value="29" min="0" max="100">
      <span id="cardLabel">29%</span>
    </div>
  </fieldset>

  <fieldset>
    <legend>Spend per Head</legend>
    <div class="input-grid">
      <label>Raffle Strips per Person:</label>
      <input type="number" id="rafflePer" value="1.29" min="0" step="0.01">
      <span id="rafflePerValue" style="font-weight: bold;">= £6.45</span>

      <label>Fish Race Tickets per Person:</label>
      <input type="number" id="fishPer" value="1.41" min="0" step="0.01">
      <span id="fishPerValue" style="font-weight: bold;">= £7.05</span>

      <label>Bottle Comp Goes per Person:</label>
      <input type="number" id="bottlePer" value="1.10" min="0" step="0.01">
      <span id="bottlePerValue" style="font-weight: bold;">= £1.10</span>
    </div>
    <div style="margin-top: 15px; text-align: right;">
      <label><input type="checkbox" id="raffleAuto" checked> Auto-calculate Raffle</label>
      <label style="margin-left: 15px;"><input type="checkbox" id="fishAuto" checked> Auto-calculate Fish</label>
      <label style="margin-left: 15px;"><input type="checkbox" id="bottleAuto" checked> Auto-calculate Bottle</label>
      <button id="resetAuto" style="margin-left: 15px;">Reset All to Auto</button>
    </div>
  </fieldset>

  <fieldset>
    <legend>Estimated Number of Buyers</legend>
    <p class="note">Suggests optimal number of buyers based on realistic purchasing patterns (1-3 items per person average)</p>
    <div class="calc-grid">
      <div class="calc-card">
        <h3>Raffle Strips</h3>
        <div>Total strips: <strong id="calcRTotal">0</strong></div>
        <div id="raffleBest" class="best-suggestion"></div>
        <table class="divisor-table" id="raffleTable"></table>
      </div>
      <div class="calc-card">
        <h3>Fish Race Tickets</h3>
        <div>Total tickets: <strong id="calcFTotal">0</strong></div>
        <div id="fishBest" class="best-suggestion"></div>
        <table class="divisor-table" id="fishTable"></table>
      </div>
      <div class="calc-card">
        <h3>Bottle Comp (5-go sets)</h3>
        <div>Total goes: <strong id="calcBTotal">0</strong> → Sets: <strong id="calcBSets">0</strong></div>
        <div id="bottleBest" class="best-suggestion"></div>
        <table class="divisor-table" id="bottleTable"></table>
      </div>
    </div>
  </fieldset>

  <h2 style="margin-top: 40px;">Summary (Group 1 Only)</h2>
  <button id="exportBtn">Export Results to Excel (CSV)</button>
  <div class="summary">
    <div class="card">Attendance: <span id="summaryAttendance"></span></div>
    <div class="card">Wine Bottles: <span id="summaryBottles"></span></div>
    <div class="card">Wine Cost: <span id="summaryWineCost"></span></div>
    <div class="card">Bottles per Person: <span id="summaryBottlesPerPerson"></span></div>
    <div class="card income">Gross Revenue: <span id="summaryGrossRevenue"></span></div>
    <div class="card cost">Card Fees: <span id="summaryCardFees"></span></div>
    <div class="card income">Net Revenue: <span id="summaryNetRevenue"></span></div>
    <div class="card">Spend per Head: <span id="summarySPH"></span></div>
    <div class="card profit-positive">Net Profit: <span id="netProfit"></span></div>
  </div>

  <h2>Scenario — Group 1 (Scroll Right →)</h2>
  <table>
    <thead>
      <tr>
        <th>Scenario</th>
        <th>Attendance</th>
        <th>Masonic %</th>
        <th>Non-Masonic %</th>
        <th>Prices</th>
        <th>Ticket Revenue</th>
        <th>Raffle</th>
        <th>Fish Race</th>
        <th>Bottle Comp</th>
        <th>Gross Revenue</th>
        <th>Card Fees</th>
        <th>Net Revenue</th>
        <th>Meals</th>
        <th>Wine</th>
        <th>Fixed Costs</th>
        <th>Variable Costs</th>
        <th>Gross Profit</th>
        <th>Total Costs</th>
        <th>Net Profit</th>
      </tr>
    </thead>
    <tbody id="scenariosTableBody"></tbody>
  </table>

  <script>
    function formatCurrency(value) {
      return (value < 0 ? "("+new Intl.NumberFormat('en-GB',{style:'currency',currency:'GBP'}).format(Math.abs(value))+")" 
                        : new Intl.NumberFormat('en-GB',{style:'currency',currency:'GBP'}).format(value));
    }
    function formatProfit(value) {
      return value >= 0 ? '+'+formatCurrency(value) : formatCurrency(value);
    }
    function getProfitClass(value) {
      return value >= 0 ? 'profit-positive' : 'profit-negative';
    }

    // Divisor calculation helpers
    function isPrime(n) {
      if (n <= 1) return false;
      if (n <= 3) return true;
      if (n % 2 === 0 || n % 3 === 0) return false;
      for (let i = 5; i * i <= n; i += 6) {
        if (n % i === 0 || n % (i + 2) === 0) return false;
      }
      return true;
    }

    function getDivisors(n, maxLimit) {
      const divisors = [];
      if (n <= 0) return divisors;
      const limit = Math.min(n, maxLimit);
      for (let i = 1; i <= limit; i++) {
        if (n % i === 0) divisors.push(i);
      }
      return divisors;
    }

    function findBestDivisor(total, attendance) {
      if (attendance <= 0 || total <= 0) return null;
      
      // Check if total is prime
      if (isPrime(total)) {
        // Suggest adding 1 to make it divisible
        const adjusted = total + 1;
        const divisors = getDivisors(adjusted, attendance);
        if (divisors.length > 1) {
          const withAvg = divisors.map(d => ({
            buyers: d,
            avg: adjusted / d,
            adjusted: true,
            originalTotal: total,
            newTotal: adjusted
          }));
          
          const ideal = withAvg.filter(d => d.avg >= 1 && d.avg <= 3 && d.buyers > 1);
          if (ideal.length > 0) {
            ideal.sort((a, b) => b.buyers - a.buyers);
            return ideal[0];
          }
          
          const nonTrivial = withAvg.filter(d => d.buyers > 1);
          if (nonTrivial.length > 0) {
            nonTrivial.sort((a, b) => b.buyers - a.buyers);
            return nonTrivial[0];
          }
        }
      }
      
      // Normal divisor logic
      const divisors = getDivisors(total, attendance);
      if (divisors.length === 0) return null;
      
      const withAvg = divisors.map(d => ({
        buyers: d,
        avg: total / d,
        adjusted: false
      }));
      
      // Find divisors in the 1-3 range
      const ideal = withAvg.filter(d => d.avg >= 1 && d.avg <= 3);
      if (ideal.length > 0) {
        // Pick the one with most buyers
        ideal.sort((a, b) => b.buyers - a.buyers);
        return ideal[0];
      }
      
      // Otherwise pick the highest divisor
      withAvg.sort((a, b) => b.buyers - a.buyers);
      return withAvg[0];
    }

    function buildDivisorTable(total, attendance, maxRows = null) {
      const divisors = getDivisors(total, attendance);
      if (divisors.length === 0) return '<tr><td colspan="2" class="note">No valid splits</td></tr>';
      
      let html = '<tr><th>Buyers</th><th>Avg/person</th></tr>';
      divisors.reverse();
      
      const rowsToShow = maxRows ? divisors.slice(0, maxRows) : divisors;
      
      rowsToShow.forEach(d => {
        const avg = Math.round(total / d);
        html += `<tr><td>${d}</td><td>${avg}</td></tr>`;
      });
      return html;
    }

    function getInputValues() {
      return {
        venueHire: parseFloat(document.getElementById('venueHire').value)||0,
        comedian: parseFloat(document.getElementById('comedian').value)||0,
        baseAttendance: parseInt(document.getElementById('attendanceInput').value)||0,
        masonicPercent: parseInt(document.getElementById('masonicPercent').value)||0,
        nonMasonicPercent: 100-(parseInt(document.getElementById('masonicPercent').value)||0),
        wineBottles: parseInt(document.getElementById('wineBottlesInput').value)||0,
        compTickets: parseInt(document.getElementById('compTickets').value)||0,
        charityContribution: parseFloat(document.getElementById('charityInput').value)||0,
        raffleIncome: parseFloat(document.getElementById('raffleIncome').value)||0,
        fishRaceIncome: parseFloat(document.getElementById('fishRaceIncome').value)||0,
        bottleCompIncome: parseFloat(document.getElementById('bottleCompIncome').value)||0,
        cardPercent: parseInt(document.getElementById('cardTransactions').value)||0,
        mealCostPerGuest: 32,
        winePerBottle: 19.5,
        masonicPrice: 40,
        nonMasonicPrice: 35
      };
    }

    function calculateScenario(groupName, prices, inputValues) {
      const attendance = inputValues.baseAttendance;
      // Paid attendees = total attendance - complimentary tickets
      const paidAttendees = Math.max(attendance - inputValues.compTickets, 0);

      // Distribute paid attendees by masonic % (complimentary do NOT affect the distribution)
      const masonicPaid = Math.round(paidAttendees * inputValues.masonicPercent / 100);
      const nonMasonicPaid = paidAttendees - masonicPaid;

      // Revenue Calculations (from paid attendees only)
      const ticketRevenue = (masonicPaid * prices.masonic) + (nonMasonicPaid * prices.nonMasonic);
      const sideIncome = inputValues.raffleIncome + inputValues.fishRaceIncome + inputValues.bottleCompIncome;
      const grossRevenue = ticketRevenue + sideIncome; // net of card fees — card fees now treated as a cost

      // Card Fee Calculations (1.5% + £0.20 per transaction)
      const totalTickets = paidAttendees; // number of paid transactions
      const avgTicketPrice = totalTickets>0 ? ticketRevenue/totalTickets : 0;
      const cardFeePerTicket = (avgTicketPrice*0.015)+0.20;
      const totalCardFees = (totalTickets*(inputValues.cardPercent/100))*cardFeePerTicket;

      // Cost Calculations
      // Meals cost applies to ALL attendees (including complimentary) because you pay for every meal
      const mealsCost = attendance * inputValues.mealCostPerGuest;
      const wineCost = inputValues.wineBottles * inputValues.winePerBottle;
      const fixedCosts = inputValues.venueHire + inputValues.comedian;
      // Variable costs now include: meals, wine, other misc, AND card fees
      const variableCosts = mealsCost + wineCost + inputValues.charityContribution + totalCardFees;
      const totalCosts = fixedCosts + variableCosts;

      // Profit Calculations
      // Gross Profit = Gross Revenue - Direct Variable Costs (Meals + Wine)  (keeps the same meaning)
      const grossProfit = grossRevenue - mealsCost - wineCost;
      // Net Profit = Gross Revenue - All Costs (Fixed + Variable + Card Fees already included in variableCosts)
      const netProfit = grossRevenue - totalCosts;

      return {
        name: groupName,
        attendance,
        paidAttendees,
        compTickets: inputValues.compTickets,
        masonicPercent: inputValues.masonicPercent,
        nonMasonicPercent: inputValues.nonMasonicPercent,
        masonicPrice: prices.masonic,
        nonMasonicPrice: prices.nonMasonic,
        ticketRevenue, sideIncome, grossRevenue, totalCardFees, netRevenue: grossRevenue - totalCardFees,
        mealsCost, wineCost, fixedCosts, variableCosts, grossProfit, totalCosts, netProfit,
        masonicPaid, nonMasonicPaid
      };
    }

    function updateCalculations() {
      const inputValues = getInputValues();
      const attendance = inputValues.baseAttendance;

      // Handle auto-calculation modes — use PAID attendees for per-person averages
      const raffleAuto = document.getElementById('raffleAuto').checked;
      const fishAuto = document.getElementById('fishAuto').checked;
      const bottleAuto = document.getElementById('bottleAuto').checked;

      const paidAttendees = Math.max(attendance - inputValues.compTickets, 0);

      if (raffleAuto && paidAttendees > 0) {
        const perPerson = inputValues.raffleIncome / 5 / paidAttendees;
        document.getElementById('rafflePer').value = perPerson.toFixed(2);
      } else if (!raffleAuto) {
        const perPerson = parseFloat(document.getElementById('rafflePer').value) || 0;
        inputValues.raffleIncome = perPerson * 5 * paidAttendees;
        document.getElementById('raffleIncome').value = inputValues.raffleIncome.toFixed(2);
      }

      if (fishAuto && paidAttendees > 0) {
        const perPerson = inputValues.fishRaceIncome / 5 / paidAttendees;
        document.getElementById('fishPer').value = perPerson.toFixed(2);
      } else if (!fishAuto) {
        const perPerson = parseFloat(document.getElementById('fishPer').value) || 0;
        inputValues.fishRaceIncome = perPerson * 5 * paidAttendees;
        document.getElementById('fishRaceIncome').value = inputValues.fishRaceIncome.toFixed(2);
      }

      if (bottleAuto && paidAttendees > 0) {
        const perPerson = inputValues.bottleCompIncome / 1 / paidAttendees;
        document.getElementById('bottlePer').value = perPerson.toFixed(2);
      } else if (!bottleAuto) {
        const perPerson = parseFloat(document.getElementById('bottlePer').value) || 0;
        inputValues.bottleCompIncome = perPerson * 1 * paidAttendees;
        document.getElementById('bottleCompIncome').value = inputValues.bottleCompIncome.toFixed(2);
      }

      // Update per-person displays
      const rafflePer = parseFloat(document.getElementById('rafflePer').value) || 0;
      const fishPer = parseFloat(document.getElementById('fishPer').value) || 0;
      const bottlePer = parseFloat(document.getElementById('bottlePer').value) || 0;
      
      document.getElementById('rafflePerValue').textContent = '= ' + formatCurrency(rafflePer * 5);
      document.getElementById('fishPerValue').textContent = '= ' + formatCurrency(fishPer * 5);
      document.getElementById('bottlePerValue').textContent = '= ' + formatCurrency(bottlePer * 1);

      // Update counts
      const raffleStrips = Math.round(inputValues.raffleIncome / 5);
      const fishTickets = Math.round(inputValues.fishRaceIncome / 5);
      const bottleGoes = Math.round(inputValues.bottleCompIncome / 1);
      
      document.getElementById('raffleCount').textContent = `(${raffleStrips} strips)`;
      document.getElementById('fishCount').textContent = `(${fishTickets} tickets)`;
      document.getElementById('bottleCount').textContent = `(${bottleGoes} goes)`;

      // Update Masonic % display with split — show split for PAID attendees only
      document.getElementById('masonicLabel').textContent = inputValues.masonicPercent + '%';
      const masonicGuests = Math.round(Math.max(attendance - inputValues.compTickets,0) * inputValues.masonicPercent / 100);
      const nonMasonicGuests = Math.max(attendance - inputValues.compTickets,0) - masonicGuests;
      document.getElementById('masonicGuests').textContent = masonicGuests;
      document.getElementById('nonMasonicGuests').textContent = nonMasonicGuests;

      // Update card slider label
      document.getElementById('cardLabel').textContent = inputValues.cardPercent + '%';

      // Calculate only Group 1
      const group1Scenario = calculateScenario('Group 1', {masonic:40, nonMasonic:35}, inputValues);

      const totalWineCost = inputValues.wineBottles * inputValues.winePerBottle;
      document.getElementById('summaryAttendance').textContent = inputValues.baseAttendance;
      document.getElementById('summaryBottles').textContent = inputValues.wineBottles;
      document.getElementById('summaryWineCost').textContent = formatCurrency(totalWineCost);

      const bottlesPerPerson = inputValues.baseAttendance>0 ? inputValues.wineBottles/inputValues.baseAttendance : 0;
      document.getElementById('summaryBottlesPerPerson').textContent = bottlesPerPerson.toFixed(2);

      const grossRevenue = group1Scenario.grossRevenue;
      const cardFees = group1Scenario.totalCardFees;
      const netRevenue = group1Scenario.netRevenue; // netRevenue already defined in scenario
      document.getElementById('summaryGrossRevenue').textContent = formatCurrency(grossRevenue);
      document.getElementById('summaryCardFees').textContent = formatCurrency(-cardFees);
      document.getElementById('summaryNetRevenue').textContent = formatCurrency(netRevenue);

      const totalSPH = rafflePer * 5 + fishPer * 5 + bottlePer * 1;
      document.getElementById('summarySPH').textContent = formatCurrency(totalSPH);

      // Display net profit
      const netProfitValue = group1Scenario.netProfit;
      const netProfitEl = document.getElementById('netProfit');
      netProfitEl.textContent = formatProfit(netProfitValue);
      netProfitEl.parentElement.className = 'card ' + getProfitClass(netProfitValue);

      // Update buyers calculator
      const raffleBest = findBestDivisor(raffleStrips, Math.max(attendance - inputValues.compTickets,0));
      document.getElementById('calcRTotal').innerHTML = raffleBest && raffleBest.adjusted
        ? `${raffleStrips} <span style="color: #d32f2f;">(prime)</span> → ${raffleBest.newTotal}`
        : raffleStrips;
      
      const fishBest = findBestDivisor(fishTickets, Math.max(attendance - inputValues.compTickets,0));
      document.getElementById('calcFTotal').innerHTML = fishBest && fishBest.adjusted
        ? `${fishTickets} <span style="color: #d32f2f;">(prime)</span> → ${fishBest.newTotal}`
        : fishTickets;
      
      document.getElementById('calcBTotal').textContent = bottleGoes;
      const bottleSets = Math.floor(bottleGoes / 5);
      const bottleBestCalc = findBestDivisor(bottleSets, Math.max(attendance - inputValues.compTickets,0));
      document.getElementById('calcBSets').innerHTML = bottleBestCalc && bottleBestCalc.adjusted
        ? `${bottleSets} <span style="color: #d32f2f;">(prime)</span> → ${bottleBestCalc.newTotal}`
        : bottleSets;

      // Display best suggestions
      if (raffleBest) {
        if (raffleBest.adjusted) {
          document.getElementById('raffleBest').innerHTML = 
            `<strong style="color: #2e7d32;">✓ Adjusted:</strong> ${raffleBest.originalTotal} is prime → ${raffleBest.newTotal} strips<br>` +
            `Best: ${raffleBest.buyers} buyers × ${raffleBest.avg.toFixed(2)} strips each`;
        } else {
          document.getElementById('raffleBest').textContent = 
            `Best: ${raffleBest.buyers} buyers × ${raffleBest.avg.toFixed(2)} strips each`;
        }
      } else {
        document.getElementById('raffleBest').textContent = 'No valid splits';
      }

      if (fishBest) {
        if (fishBest.adjusted) {
          document.getElementById('fishBest').innerHTML = 
            `<strong style="color: #2e7d32;">✓ Adjusted:</strong> ${fishBest.originalTotal} is prime → ${fishBest.newTotal} tickets<br>` +
            `Best: ${fishBest.buyers} buyers × ${fishBest.avg.toFixed(2)} tickets each`;
        } else {
          document.getElementById('fishBest').textContent = 
            `Best: ${fishBest.buyers} buyers × ${fishBest.avg.toFixed(2)} tickets each`;
        }
      } else {
        document.getElementById('fishBest').textContent = 'No valid splits';
      }

      if (bottleBestCalc) {
        if (bottleBestCalc.adjusted) {
          document.getElementById('bottleBest').innerHTML = 
            `<strong style="color: #2e7d32;">✓ Adjusted:</strong> ${bottleBestCalc.originalTotal} is prime → ${bottleBestCalc.newTotal} sets<br>` +
            `Best: ${bottleBestCalc.buyers} buyers × ${bottleBestCalc.avg.toFixed(2)} sets each`;
        } else {
          document.getElementById('bottleBest').textContent = 
            `Best: ${bottleBestCalc.buyers} buyers × ${bottleBestCalc.avg.toFixed(2)} sets each`;
        }
      } else {
        document.getElementById('bottleBest').textContent = 'No valid splits';
      }

      // Update divisor tables
      document.getElementById('raffleTable').innerHTML = raffleBest && raffleBest.adjusted 
        ? buildDivisorTable(raffleBest.newTotal, Math.max(attendance - inputValues.compTickets,0))
        : buildDivisorTable(raffleStrips, Math.max(attendance - inputValues.compTickets,0));
      document.getElementById('fishTable').innerHTML = fishBest && fishBest.adjusted
        ? buildDivisorTable(fishBest.newTotal, Math.max(attendance - inputValues.compTickets,0), 5)
        : buildDivisorTable(fishTickets, Math.max(attendance - inputValues.compTickets,0), 5);
      document.getElementById('bottleTable').innerHTML = bottleBestCalc && bottleBestCalc.adjusted
        ? buildDivisorTable(bottleBestCalc.newTotal, Math.max(attendance - inputValues.compTickets,0))
        : buildDivisorTable(bottleSets, Math.max(attendance - inputValues.compTickets,0));

      // Update scenario table (Group 1 only)
      const tableBody = document.getElementById('scenariosTableBody');
      tableBody.innerHTML = '';
      const row = document.createElement('tr');
      row.innerHTML = `
        <td><strong>Group 1</strong></td>
        <td>${group1Scenario.attendance} (Paid: ${group1Scenario.paidAttendees}, Comp: ${group1Scenario.compTickets})</td>
        <td>${group1Scenario.masonicPercent}%</td>
        <td>${group1Scenario.nonMasonicPercent}%</td>
        <td><small>M: £40<br>NM: £35</small></td>
        <td class="income">${formatCurrency(group1Scenario.ticketRevenue)}</td>
        <td class="income">${formatCurrency(inputValues.raffleIncome)}</td>
        <td class="income">${formatCurrency(inputValues.fishRaceIncome)}</td>
        <td class="income">${formatCurrency(inputValues.bottleCompIncome)}</td>
        <td class="income">${formatCurrency(group1Scenario.grossRevenue)}</td>
        <td class="cost">(${formatCurrency(group1Scenario.totalCardFees)})</td>
        <td class="income">${formatCurrency(group1Scenario.netRevenue)}</td>
        <td class="cost">(${formatCurrency(group1Scenario.mealsCost)})</td>
        <td class="cost">(${formatCurrency(group1Scenario.wineCost)})</td>
        <td class="cost">(${formatCurrency(group1Scenario.fixedCosts)})</td>
        <td class="cost">(${formatCurrency(group1Scenario.variableCosts)})</td>
        <td class="${getProfitClass(group1Scenario.grossProfit)}">${formatProfit(group1Scenario.grossProfit)}</td>
        <td class="cost">(${formatCurrency(group1Scenario.totalCosts)})</td>
        <td class="${getProfitClass(group1Scenario.netProfit)}">${formatProfit(group1Scenario.netProfit)}</td>
      `;
      tableBody.appendChild(row);

      const table = document.querySelector('table');
      if (table && typeof table.scrollLeft !== 'undefined') {
        table.scrollLeft = table.scrollWidth;
      }
    }

    // Event listeners
    document.querySelectorAll('input[type="number"], input[type="range"]').forEach(el => {
      el.addEventListener('input', updateCalculations);
    });

    document.querySelectorAll('#raffleAuto, #fishAuto, #bottleAuto').forEach(el => {
      el.addEventListener('change', updateCalculations);
    });

    document.getElementById('resetAuto').addEventListener('click', () => {
      document.getElementById('raffleAuto').checked = true;
      document.getElementById('fishAuto').checked = true;
      document.getElementById('bottleAuto').checked = true;
      updateCalculations();
    });

    // Export to CSV
    document.getElementById('exportBtn').addEventListener('click', () => {
      const inputs = getInputValues();
      const rows = [
        ['Field','Value'],
        ['Venue Hire', inputs.venueHire],
        ['Comedian', inputs.comedian],
        ['Attendance', inputs.baseAttendance],
        ['Complimentary Tickets', inputs.compTickets],
        ['Masonic %', inputs.masonicPercent],
        ['Non-Masonic %', inputs.nonMasonicPercent],
        ['Wine Bottles', inputs.wineBottles],
        ['Misc Costs', inputs.charityContribution],
        ['Raffle Income', inputs.raffleIncome],
        ['Fish Race Income', inputs.fishRaceIncome],
        ['Bottle Comp Income', inputs.bottleCompIncome],
        ['Card %', inputs.cardPercent]
      ];

      const scenario = calculateScenario('Group 1',{masonic:40,nonMasonic:35},inputs);
      rows.push(['---Scenario Results---','']);
      rows.push(['Ticket Revenue', scenario.ticketRevenue]);
      rows.push(['Gross Revenue', scenario.grossRevenue]);
      rows.push(['Card Fees', scenario.totalCardFees]);
      rows.push(['Net Revenue', scenario.netRevenue]);
      rows.push(['Meals Cost', scenario.mealsCost]);
      rows.push(['Wine Cost', scenario.wineCost]);
      rows.push(['Fixed Costs', scenario.fixedCosts]);
      rows.push(['Variable Costs', scenario.variableCosts]);
      rows.push(['Total Costs', scenario.totalCosts]);
      rows.push(['Net Profit', scenario.netProfit]);

      let csv = rows.map(r => r.join(',')).join('\n');
      const blob = new Blob([csv],{type:'text/csv'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'Macnab_Results.csv';
      a.click();
    });

    updateCalculations();
  </script>
</body>
</html>

